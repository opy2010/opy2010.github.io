<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 1. ÁΩëÁ´ôÊ†áÈ¢ò (Google ÊêúÁ¥¢ÁªìÊûúÁöÑÂ§ßÊ†áÈ¢ò) -->
    <title>Global Alpha | ÁæéËÇ°‰∏éÂÆèËßÇÁ≠ñÁï•ÂàÜÊûê (Market Intelligence)</title>
    
    <!-- 2. ÁΩëÁ´ôÊèèËø∞ (Google ÊêúÁ¥¢ÁªìÊûúÊ†áÈ¢ò‰∏ãÊñπÁöÑ‰∏§Ë°åÂ∞èÂ≠ó) -->
    <!-- ‚ö†Ô∏è ËøôÈáåÈùûÂ∏∏ÈáçË¶ÅÔºåË¶ÅÁî®ÁÆÄÁü≠ÁöÑËØù‰ªãÁªç‰Ω†ÁöÑÁΩëÁ´ô‰ª∑ÂÄº -->
    <meta name="description" content="ÊØèÊó•ÁæéËÇ°Â§çÁõò„ÄÅÂ∑¥Ëè≤Áâπ‰∏éÂçéÂ∞îË°óÂ§ßÂ∏àÊÄùÁª¥ÂàÜÊûê„ÄÅÈáèÂåñ‰∫§ÊòìÁ≠ñÁï•‰∏éÂÖ®ÁêÉÂÆèËßÇÁªèÊµéËß£ËØª„ÄÇÊèê‰æõ‰∏≠Ëã±ÊñáÂèåËØ≠ÁöÑÊ∑±Â∫¶ÈáëËûçÊäïËµÑÂàÜÊûê„ÄÇ">
    
    <!-- 3. ÂÖ≥ÈîÆËØç (ËæÖÂä© SEOÔºåÂëäËØâÂºïÊìé‰Ω†ÁöÑÁΩëÁ´ôÂÖ≥‰∫é‰ªÄ‰πà) -->
    <meta name="keywords" content="ÁæéËÇ°ÂàÜÊûê, ÈáèÂåñ‰∫§Êòì, Â∑¥Ëè≤Áâπ, Á∫≥ÊñØËææÂÖã, ÊäïËµÑÁ≠ñÁï•, ÂÆèËßÇÁªèÊµé, AIÈÄâËÇ°">
    
    <!-- Vue 3 & Tailwind -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <!-- Markdown Ëß£ÊûêÂ∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Ê†∑Âºè‰øùÊåÅ‰∏çÂèò -->
    <style>
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        [v-cloak] { display: none; }
        .goog-te-banner-frame { display: none !important; }
        body { top: 0px !important; } 
        #google_translate_element select { border: 1px solid #cbd5e1; border-radius: 4px; padding: 2px; font-size: 11px; }
        .goog-logo-link { display: none !important; }
        .goog-te-gadget { color: transparent !important; }
        /* Markdown Ê†∑ÂºèË°•‰∏Å */
        .markdown-body p { margin-bottom: 0.8em; line-height: 1.6; }
        .markdown-body strong { color: #0f172a; font-weight: 700; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .markdown-body li { margin-bottom: 0.2em; }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 { 
            font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e293b; 
        }
    </style>
</head>
<body class="bg-slate-50 font-sans min-h-screen text-slate-800">

<div id="app" v-cloak>
    
    <!-- 1. È°∂ÈÉ®‰∏ªÂØºËà™Ê†è -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-slate-200">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex items-center cursor-pointer mr-8" @click="resetToHome">
                    <span class="text-3xl mr-2">üèõÔ∏è</span>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight text-slate-900 leading-none">GLOBAL</h1>
                        <span class="text-[10px] text-slate-500 font-bold tracking-widest">ALPHA</span>
                    </div>
                </div>

                <!-- Ê°åÈù¢Á´ØËèúÂçï -->
                <div class="hidden md:flex items-center flex-1">
                    
                    <!-- Êñ∞Â¢ûÔºöÊòæÁúºÁöÑ‚ÄúÊúÄÊñ∞Âä®ÊÄÅ‚ÄùÊåâÈíÆ -->
                    <button @click="resetToHome" 
                            :class="['px-3 py-2 text-sm font-bold mr-2 rounded transition', currentCategory === 'home' ? 'bg-slate-800 text-white' : 'text-slate-700 hover:bg-slate-100']">
                        {{ lang === 'zh' ? 'ÊúÄÊñ∞Âä®ÊÄÅ' : 'Latest' }}
                    </button>
                    <!-- üü¢ [Êñ∞Â¢û] Á§æÂå∫ÂÖ•Âè£ÊåâÈíÆ -->
                    <button @click="currentCategory = 'community'" 
                            :class="['px-3 py-2 text-sm font-bold mr-2 rounded transition flex items-center', currentCategory === 'community' ? 'bg-indigo-600 text-white' : 'text-indigo-600 hover:bg-indigo-50']">
                        <span class="mr-1">üí¨</span> {{ lang === 'zh' ? 'ÊäïËµÑËÄÖÁ§æÂå∫' : 'Community' }}
                    </button>

                    <!-- ÂàÜÁ±ª‰∏ãÊãâËèúÂçï -->
                    <div v-for="(menu, index) in menuStructure" :key="index" class="relative group px-3 py-2">
                        <button class="text-sm font-bold text-slate-700 hover:text-blue-600 flex items-center">
                            {{ lang === 'zh' ? menu.name_zh : menu.name_en }}
                            <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <!-- ‰∏ãÊãâÂÜÖÂÆπ -->
                        <div class="absolute left-0 mt-2 w-48 bg-white rounded shadow-xl py-2 hidden group-hover:block border border-slate-100 z-50">
                            <a v-for="sub in menu.sub" @click="selectCategory(sub.id, sub.isStreamlit)"
                               class="block px-4 py-2 text-sm text-slate-600 hover:bg-blue-50 hover:text-blue-700 cursor-pointer">
                                {{ lang === 'zh' ? sub.name_zh : sub.name_en }}
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Âè≥‰æßÂ∑•ÂÖ∑Ê†è -->
                <div class="flex items-center space-x-3">
                    <button @click="toggleLang" class="px-2 py-1 bg-slate-100 border rounded text-xs font-bold hover:bg-slate-200">
                        {{ lang === 'zh' ? 'English/‰∏≠Êñá: CN' : 'English/‰∏≠Êñá: EN' }}
                    </button>
                    <div id="google_translate_element"></div>
                    <button @click="addToFavorite" class="bg-yellow-400 hover:bg-yellow-500 text-slate-900 px-3 py-1 rounded text-xs font-bold flex items-center">
                        ‚òÖ {{ lang === 'zh' ? 'Êî∂Ëóè' : 'Save' }}
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 2. ‰∫åÁ∫ßÁ≠õÈÄâÊ†è (Á±ª‰ººËßÜÈ¢ëÁΩëÁ´ôÁöÑ Tag ÂàóË°®) -->
    <!-- ‰ªÖÂΩì‰∏çÂú® Streamlit Ê®°Âºè‰∏îÊúâÂ≠êËèúÂçïÊó∂ÊòæÁ§∫ -->
    <div v-if="!showStreamlit && currentCategory !== 'community'" class="bg-white border-b border-slate-200 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2 overflow-x-auto no-scrollbar">
            <span class="text-xs font-bold text-slate-400 uppercase mr-2 shrink-0">
                {{ lang === 'zh' ? 'Âø´ÈÄüÁ≠õÈÄâ:' : 'Filter:' }}
            </span>
            
            <!-- ÊòæÁ§∫ÂΩìÂâçÊøÄÊ¥ªÁöÑÂ§ßÁ±ª‰∏ãÁöÑÂ≠êÁ±ªÔºåÊàñËÄÖÊòØÂÖ®ÈÉ®ÁÉ≠Èó®Ê†áÁ≠æ -->
            <button 
                v-for="tag in activeTags"
                :key="tag.id"
                class="shrink-0 whitespace-nowrap px-3 py-1 text-xs rounded-full border transition"
                :key="tag.id"
                    @click="selectCategory(tag.id, tag.isStreamlit)"
                    :class="['px-3 py-1 text-xs rounded-full border transition whitespace-nowrap', 
                             currentCategory === tag.id 
                             ? 'bg-blue-600 text-white border-blue-600' 
                             : 'bg-white text-slate-600 border-slate-200 hover:border-blue-400 hover:text-blue-600']">
                {{ lang === 'zh' ? tag.name_zh : tag.name_en }}
            </button>
        </div>
    </div>

    <!-- 3. ‰∏ª‰ΩìÂÜÖÂÆπ -->
    <main class="max-w-7xl mx-auto px-4 py-6 flex gap-8">
        <!-- üü¢ [Êñ∞Â¢û] Á§æÂå∫ËÅäÂ§©ÂÆ§ËßÜÂõæ -->
        <div v-if="currentCategory === 'community'" class="w-full bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col h-[800px]">
            <div class="border-b border-slate-100 pb-4 mb-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800">{{ lang === 'zh' ? 'ÊäïËµÑËÄÖËÆ®ËÆ∫Âå∫' : 'Investor Hub' }}</h2>
                <span class="text-sm text-slate-400">{{ comments.length }} Posts</span>
            </div>
            <!-- ÁïôË®ÄÂàóË°® -->
            <div class="flex-1 overflow-y-auto space-y-6 pr-2 mb-4">
                <div v-for="c in comments" :key="c.id" class="flex gap-4">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shrink-0" 
                        :style="{ backgroundColor: stringToColor(c.user || 'G') }">{{ (c.user || 'G')[0].toUpperCase() }}</div>
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-slate-800">{{ c.user || 'Guest' }}</span>
                            <span class="text-xs text-slate-400">{{ new Date(c.timestamp?.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) }}</span>
                        </div>
                        <div class="bg-slate-50 p-3 rounded-lg text-slate-700 text-sm border border-slate-100">{{ c.text }}</div>
                    </div>
                </div>
            </div>
            <!-- ÂèëÈÄÅÂå∫ -->
            <div class="border-t border-slate-100 pt-4">
                <input v-model="userNickname" class="w-1/3 border rounded px-3 py-2 text-sm mb-2" :placeholder="lang==='zh'?'ÊÇ®ÁöÑÊòµÁß∞':'Nickname'">
                <div class="flex gap-2">
                    <textarea v-model="newComment" class="flex-1 border rounded px-3 py-2 text-sm h-20 resize-none" :placeholder="lang==='zh'?'ÂèëË°®ÁúãÊ≥ï...':'Join discussion...'"></textarea>
                    <button @click="submitComment" class="bg-indigo-600 text-white px-6 rounded font-bold hover:bg-indigo-700">{{ lang==='zh'?'ÂèëÂ∏É':'Post' }}</button>
                </div>
            </div>
        </div>

        <!-- üü¢ [‰øÆÊîπ] ÁªôÂéüÊù•ÁöÑÊñáÁ´†ÂàóË°®Âíå‰æßËæπÊ†èÂä†‰∏ä v-else -->
        <template v-else>
        <!-- Â∑¶‰æßÊñáÁ´†ÊµÅ -->
        <div class="flex-1">
            <div class="mb-4 flex items-end justify-between">
                <h2 class="text-xl font-bold text-slate-800 flex items-center">
                    <span class="mr-2 text-blue-600">|</span> 
                    {{ getCurrentCategoryTitle() }}
                </h2>
                <span v-if="loading" class="text-xs text-slate-400 animate-pulse">Data Syncing...</span>
            </div>

            <!-- Streamlit ÂÆπÂô® -->
            <div v-if="showStreamlit" class="w-full h-[850px] bg-white rounded-xl shadow border border-slate-200 overflow-hidden relative">
                <iframe src="https://share.streamlit.io/" class="w-full h-full border-0 relative z-10"></iframe>
            </div>

        <div v-else>
          <!-- ÂÆûÊó∂Êä•‰ª∑Ë°®Ê†ºÔºàÂΩì currentCategory Â±û‰∫é live_* Êó∂ÊòæÁ§∫Ôºâ -->
          <div v-if="currentCategory === 'live_global' || currentCategory === 'live_stocks' || currentCategory === 'live_indices'"
               class="bg-white rounded border p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="font-bold">{{ lang==='zh'?'ÂÆûÊó∂Êä•‰ª∑ÔºàÁõòÂêé/ÊØè5ÂàÜÈíüÂà∑Êñ∞Ôºâ':'Market Quotes (5min)' }}</h3>
              <div class="text-sm text-slate-500">Last updated: {{ lastUpdateStr }}</div>
            </div>

            <div class="overflow-auto">
              <table class="min-w-full text-sm">
                <thead>
                  <tr class="text-left text-xs text-slate-500">
                    <th class="px-2 py-2">Symbol</th>
                    <th class="px-2 py-2">Name</th>
                    <th class="px-2 py-2">Price</th>
                    <th class="px-2 py-2">Change</th>
                    <th class="px-2 py-2">Change %</th>
                    <th class="px-2 py-2">Source</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="row in displayedRows" :key="row.symbol" class="border-t">
                    <td class="px-2 py-2 font-mono">{{ row.symbol }}</td>
                    <td class="px-2 py-2">{{ row.name }}</td>
                    <td class="px-2 py-2 font-mono">{{ formatNumber(row.price) }}</td>
                    <td class="px-2 py-2">
                      <span :class="row.change >= 0 ? 'text-rose-600' : 'text-emerald-600'">{{ formatNumber(row.change) }}</span>
                    </td>
                    <td class="px-2 py-2">
                      <span :class="row.change_pct >= 0 ? 'text-rose-600' : 'text-emerald-600'">{{ formatNumber(row.change_pct) }}%</span>
                    </td>
                    <td class="px-2 py-2 text-xs text-slate-400">{{ row.source }}</td>
                  </tr>
                  <tr v-if="displayedRows.length === 0">
                    <td colspan="6" class="px-2 py-4 text-center text-slate-400">No data</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
            <!-- ÊñáÁ´†ÂàóË°® -->
            <div v-else class="space-y-4">
                <div v-if="posts.length === 0 && !loading" class="text-center py-12 bg-white rounded border border-slate-100">
                    <p class="text-slate-400 text-sm">ÊöÇÊó†Êï∞ÊçÆ / No Data</p>
                </div>

                <article v-for="post in posts" :key="post.id" class="bg-white rounded border border-slate-200 p-5 hover:shadow-md transition duration-200">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 bg-slate-100 text-slate-600 text-[10px] font-bold uppercase rounded">
                                {{ post.subcategory || 'NEWS' }}
                            </span>
                            <span class="text-[10px] text-slate-400 font-mono">
                                {{ formatDateTime(post.timestamp) }}
                            </span>
                        </div>
                    </div>
                    
                    <!-- ÂèåËØ≠Ê†áÈ¢ò -->
                    <h3 class="text-lg font-bold text-slate-900 mb-2 cursor-pointer hover:text-blue-700">
                        {{ lang === 'zh' ? post.title_zh : post.title_en }}
                    </h3>
                    
                    <!-- ÂèåËØ≠ÂÜÖÂÆπ -->
                    <div class="text-slate-600 text-sm leading-relaxed markdown-body" 
                        v-html="renderMarkdown(lang === 'zh' ? post.content_zh : post.content_en)">
                    </div>
                </article>
            </div>
        </div>

        <!-- Âè≥‰æßËæπÊ†è -->
        <aside class="hidden lg:block w-72 space-y-6">
            <!-- ÁïôË®ÄÊùø -->
            <div class="bg-white rounded shadow-sm border border-slate-200 p-4">
                <h3 class="font-bold text-slate-800 mb-3 text-sm border-b pb-2">
                    {{ lang === 'zh' ? 'ÁïôË®ÄÊùø' : 'Comments' }}
                </h3>
                <div class="h-48 overflow-y-auto no-scrollbar space-y-2 mb-3 bg-slate-50 p-2 rounded">
                    <div v-for="c in comments" :key="c.id" class="text-xs border-b border-slate-100 last:border-0 pb-1">
                        <span class="font-bold text-slate-700">Guest:</span> 
                        <span class="text-slate-600">{{ c.text }}</span>
                    </div>
                </div>
                <div class="flex gap-1">
                    <input v-model="newComment" class="flex-1 text-xs border p-1 rounded focus:outline-none" :placeholder="lang==='zh'?'ËØ¥ÁÇπ‰ªÄ‰πà...':'Type here...'">
                    <button @click="submitComment" class="bg-slate-800 text-white text-xs px-2 rounded hover:bg-slate-700">Go</button>
                </div>
            </div>

            <!-- ÁªüËÆ° -->
            <div class="bg-slate-50 rounded p-4 text-center border border-slate-100">
                <span class="text-xs text-slate-400 uppercase">Total Views</span>
                <div class="text-xl font-mono text-slate-800 mt-1" id="busuanzi_container_site_pv">
                    <span id="busuanzi_value_site_pv">--</span>
                </div>
            </div>
        </aside>
    </template>
    </main>

    <footer class="text-center text-slate-400 text-xs py-8 border-t mt-8">
        &copy; 2025 Global Markets Analysis.
    </footer>
</div>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: false}, 'google_translate_element');
}
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, limit, getDocs } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // 1. Firebase ÈÖçÁΩÆ (‰øùÁïôÔºåÁî®‰∫éËØÑËÆ∫Âå∫)
    const firebaseConfig = {
        apiKey: "AIzaSyDoMl3klw1FTdbj4tbgxLRshlowMfLN-M0",
        authDomain: "goog8-f3754.firebaseapp.com",
        projectId: "goog8-f3754",
        storageBucket: "goog8-f3754.firebasestorage.app",
        messagingSenderId: "1017507222346",
        appId: "1:1017507222346:web:a2fbc8617eca9cf80aa7b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    // ‚ùå Âà†Èô§‰∫Ü enableIndexedDbPersistenceÔºåÂõ†‰∏∫ÂÆÉÂèØËÉΩÂØºËá¥ÁôΩÂ±èÂ¥©Ê∫É

    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            // ================= Áä∂ÊÄÅÂèòÈáè =================
            const savedLang = localStorage.getItem("lang") || "zh";
            const lang = ref(savedLang);



            const currentCategory = ref('home');
            const showStreamlit = ref(false);
            const posts = ref([]);      // ÂΩìÂâçÊòæÁ§∫ÁöÑÊñáÁ´†ÂàóË°®
            const allPosts = ref([]);   // üü¢ Ê†∏ÂøÉÔºöÂ≠òÊîæÊâÄÊúâ‰∏ãËΩΩÁöÑÊñáÁ´†ÁºìÂ≠ò
            const comments = ref([]);
            const loading = ref(true);
            const newComment = ref('');
            const userNickname = ref('');
            // === Ë°åÊÉÖÊï∞ÊçÆÂ≠òÊîæÔºàÊù•Ëá™ FirebaseÔºâ ===
            const quotes = ref([]);       // Â≠òË°åÊÉÖË°®Ê†ºÊï∞ÊçÆ
            const lastUpdate = ref(null); // Ë°åÊÉÖÊï∞ÊçÆÊõ¥Êñ∞Êó∂Èó¥

            // === Ë°åÊÉÖË°®Ê†ºÊï∞ÊçÆÔºàÂΩìÂâç‰∏â‰∏™Ê†èÁõÆÂÖ±Áî®Ôºâ ===
            const displayedRows = computed(() => {
                if (
                    currentCategory.value === "live_global" ||
                    currentCategory.value === "live_stocks" ||
                    currentCategory.value === "live_indices"
                ) {
                    return quotes.value; // Ë°åÊÉÖË°®Ê†º‰ΩøÁî® quotes
                }
                return []; // ÈùûË°åÊÉÖÊ†èÁõÆËøîÂõûÁ©∫
            });


            // ÂÆåÊï¥ÁöÑËèúÂçïÁªìÊûÑ (Áî®‰∫éÁîüÊàêÈ°∂ÈÉ®Âíå‰∫åÁ∫ßÂØºËà™)
            const menuStructure = [
            {
                name_zh: "ÊìçÁõòÊåáÂçó",
                name_en: "Daily Guide",
                sub: [
                    { id: "market_guide", name_zh: "üî• ÊØèÊó•ÊÄªÁ∫≤", name_en: "Executive Brief" },
                    { id: "news_analysis", name_zh: "üì∞ Êñ∞ÈóªËß£Êûê", name_en: "News Analysis" },     // ‚Üê Êñ∞Â¢û
                    { id: "stock_insights", name_zh: "üìà ‰∏™ËÇ°ÂàÜÊûê", name_en: "Stock Insights" }  // ‚Üê Êñ∞Â¢û
                ]
            },
            {
                name_zh: "ÂÖ®ÁêÉÂ∏ÇÂú∫",
                name_en: "Global Markets",
                sub: [
                    { id: "us_analysis", name_zh: "üá∫üá∏ ÁæéËÇ°ÂàÜÊûê", name_en: "US Market" },
                    { id: "asia_market", name_zh: "üá®üá≥üáØüáµ ‰∫öÂ§™Â∏ÇÂú∫", name_en: "Asia" },
                    { id: "global_indices", name_zh: "üåç ‰∏ñÁïåÊåáÊï∞", name_en: "World Indices" }
                ]
            },
            {
                name_zh: "ËµÑ‰∫ßÁ±ªÂà´",
                name_en: "Assets",
                sub: [
                    { id: "commodities", name_zh: "üõ¢Ô∏è ÂéüÊ≤π/ÈªÑÈáë", name_en: "Oil & Gold" },
                    { id: "macro_fed", name_zh: "üèõÔ∏è ÂÆèËßÇ/ÂõΩÂÄ∫", name_en: "Macro & Bonds" },
                ]
            },
            {
                name_zh: "ÂÆûÊó∂Êä•‰ª∑",               // ‚Üê Êñ∞Â¢û‰∏ªÊ†èÁõÆ
                name_en: "Live Markets",
                sub: [
                    { id: "live_global", name_zh: "üåé ÂÖ®ÁêÉË°åÊÉÖ", name_en: "Global Assets" },
                    { id: "live_stocks", name_zh: "üî• ÈæôÂ§¥ËÇ°Êä•‰ª∑", name_en: "Leaders" },
                    { id: "live_indices", name_zh: "üìä ‰∏ñÁïåÊåáÊï∞", name_en: "Indices" }
                ]
            },
            {
                name_zh: "Â§ßÂ∏àÊô∫ÊÖß",
                name_en: "Master's Wisdom",
                sub: [
                    { id: "buffett", name_zh: "Â∑¥Ëè≤Áâπ (‰ª∑ÂÄº)", name_en: "Buffett" },
                    { id: "soros", name_zh: "Á¥¢ÁΩóÊñØ (ÂèçË∫´ÊÄß)", name_en: "Soros" },
                    { id: "livermore", name_zh: "Âà©ÂºóËé´Â∞î (Ë∂ãÂäø)", name_en: "Livermore" },
                    { id: "wu_chaohui", name_zh: "‰ºçÊúùËæâ (‰∏ªÂäõ)", name_en: "Wu" },
                    { id: "gann", name_zh: "Ê±üÊÅ© (Êó∂Á©∫)", name_en: "Gann" }
                ]
            }
        ];


            // ================= Ê†∏ÂøÉÈÄªËæë =================

            // üü¢ 1. Âä†ËΩΩÈùôÊÄÅÊñá‰ª∂ (ËøôÊòØÊúÄÂÖ≥ÈîÆÁöÑ‰øÆÊîπ)
            const loadAllPosts = async () => {
                loading.value = true;
                try {
                    console.log("üì• ÂºÄÂßã‰∏ãËΩΩ posts.json ...");
                    // Âä†Êó∂Èó¥Êà≥Èò≤Ê≠¢ÁºìÂ≠ò
                    const res = await fetch(`posts.json?t=${new Date().getTime()}`);
                    
                    if (!res.ok) throw new Error(`Êñá‰ª∂‰∏ãËΩΩÂ§±Ë¥•: ${res.status}`);
                    
                    const data = await res.json();
                    allPosts.value = data;
                    console.log(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${data.length} ÁØáÊñáÁ´†`);
                    
                    // ÂàùÂßãÊòæÁ§∫È¶ñÈ°µ
                    filterPosts('home');
                    
                } catch (e) {
                    console.error("Âä†ËΩΩÈîôËØØ:", e);
                    posts.value = []; // Âç≥‰ΩøÂ§±Ë¥•‰πü‰∏çË¶ÅÂ¥©Ê∫É
                } finally {
                    loading.value = false;
                }
            };

            // üü¢ 2. Á∫ØÂâçÁ´ØÁ≠õÈÄâ (ÈÄüÂ∫¶ÊûÅÂø´)
            const filterPosts = (catId) => {
                if (catId === 'home') {
                    // È¶ñÈ°µÊòæÁ§∫ÊúÄÊñ∞ÁöÑ 20 Êù°
                    posts.value = allPosts.value.slice(0, 20);
                } else {
                    // ÊåâÂàÜÁ±ª ID Á≠õÈÄâ
                    posts.value = allPosts.value.filter(p => p.category === catId);
                }
            };
            // === ‰ªé Firestore ËØªÂèñË°åÊÉÖÊï∞ÊçÆÔºàÂâçÁ´ØÂè™ËØªÔºå‰∏çÊäìÂèñÂ§ñÈÉ® APIÔºâ ===
            const loadQuotesFromFirebase = async () => {
            try {
                console.log("loadQuotesFromFirebase start");
                // ËøôÈáåÂÅáËÆæ‰Ω†ÁöÑÈõÜÂêàÂêç‰∏∫ "market_quotes"ÔºõÂ¶Ç‰∏çÂêåËØ∑ÊõøÊç¢
                const q = query(collection(db, "market_quotes"));
                const snap = await getDocs(q);

                const rows = snap.docs.map(d => {
                const data = d.data();
                return {
                    symbol: data.symbol || d.id,
                    name: data.name || data.symbol || d.id,
                    price: data.price ?? null,
                    change: data.change ?? null,
                    change_pct: data.change_pct ?? null,
                    source: data.source || 'db',
                    last_update: data.last_update || Date.now()
                };
                });

                quotes.value = rows;
                lastUpdate.value = rows.length ? rows[0].last_update || Date.now() : Date.now();
                console.log("loadQuotesFromFirebase done, rows:", quotes.value.length);
            } catch (e) {
                console.error("loadQuotesFromFirebase error:", e);
                quotes.value = [];
                lastUpdate.value = null;
            }
            };



            // üü¢ 3. ÂàáÊç¢ÂàÜÁ±ª
            const selectCategory = (catId, isStreamlit = false) => {
            console.log("selectCategory", catId);
            currentCategory.value = catId;
            showStreamlit.value = isStreamlit;

            // ÁÇπÂáªË°åÊÉÖÊ†èÁõÆ ‚Äî Âè™‰ªéÊï∞ÊçÆÂ∫ìËØªÂèñÂπ∂Â±ïÁ§∫
            if (catId === "live_global" || catId === "live_stocks" || catId === "live_indices") {
                // Âè™ÊãâÂèñÊï∞ÊçÆÂ∫ìÊï∞ÊçÆÔºàÂâçÁ´ØÂè™ËØªÔºâÔºåÈÅøÂÖçÊØè‰∏™Áî®Êà∑ÂéªË∞ÉÁî®Á¨¨‰∏âÊñπ API
                loadQuotesFromFirebase();
                return;
            }

            if (catId !== "community" && !isStreamlit) filterPosts(catId);
            };


            // ================= ËæÖÂä©ÂáΩÊï∞ =================
            
            const activeTags = computed(() => {
            // ‰∏ÄÁõ¥ËøîÂõûÂÖ®ÈÉ®Â≠êÊ†èÁõÆÔºàÊâÅÂπ≥ÂåñÔºâ
            let all = [];
            menuStructure.forEach(m => { all = all.concat(m.sub); });
            return all;
            });


            const getCurrentCategoryTitle = () => {
                if (currentCategory.value === 'home') return lang.value === 'zh' ? 'ÊúÄÊñ∞Âä®ÊÄÅ' : 'Latest Updates';
                for (const group of menuStructure) {
                    const found = group.sub.find(s => s.id === currentCategory.value);
                    if (found) return lang.value === 'zh' ? found.name_zh : found.name_en;
                }
                return 'Analysis';
            };

            // ËØÑËÆ∫Áõ∏ÂÖ≥ (‰øùÊåÅ Firebase)
            const fetchComments = async () => {
                try {
                    const q = query(collection(db, "guest_comments"), orderBy("timestamp", "desc"), limit(50));
                    const snap = await getDocs(q);
                    comments.value = snap.docs.map(doc => doc.data());
                } catch(e) { console.error("ËØÑËÆ∫Âä†ËΩΩÂ§±Ë¥•", e); }
            };

            const submitComment = async () => {
                if(!newComment.value.trim()) return;
                const name = userNickname.value.trim() || "Guest Investor";
                localStorage.setItem('userNickname', name);
                await addDoc(collection(db, "guest_comments"), {
                    text: newComment.value, user: name, timestamp: serverTimestamp()
                });
                newComment.value = "";
                fetchComments();
            };


            // Â∑•ÂÖ∑ÂáΩÊï∞
            // const toggleLang = () => { lang.value = lang.value === 'zh' ? 'en' : 'zh'; };
            const toggleLang = () => {
                lang.value = lang.value === "zh" ? "en" : "zh";
                localStorage.setItem("lang", lang.value);
            };
            const resetToHome = () => { selectCategory('home'); };
            const addToFavorite = () => { alert("Ctrl+D to bookmark"); };
            const formatDateTime = (ts) => {
                if (!ts) return '';
                // ÂÖºÂÆπÂ≠óÁ¨¶‰∏≤Êó∂Èó¥
                const date = typeof ts === 'string' ? new Date(ts) : new Date(ts.seconds * 1000);
                return date.toLocaleString('en-US', { month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit', hour12:false });
            };
            const stringToColor = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
                const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
                return '#' + '00000'.substring(0, 6 - c.length) + c;
            };
            const renderMarkdown = (text) => {
                if (!text) return '';
                try { return marked.parse(text); } catch (e) { return text; }
            };

            // ================= ÂàùÂßãÂåñ =================
            onMounted(() => { 
                loadAllPosts();  // üü¢ ÂêØÂä®Êó∂Âä†ËΩΩ JSON
                fetchComments(); // Âä†ËΩΩËØÑËÆ∫
                const cached = localStorage.getItem('userNickname');
                if(cached) userNickname.value = cached;
            });

            return {
                lang, menuStructure, currentCategory, showStreamlit, posts, comments, loading, newComment, activeTags, userNickname,
                toggleLang, resetToHome, addToFavorite, selectCategory, getCurrentCategoryTitle, submitComment, formatDateTime, 
                renderMarkdown, stringToColor,
                displayedRows,
                lastUpdate,
                lastUpdateStr: computed(() => lastUpdate.value ? new Date(lastUpdate.value).toLocaleString() : "--"),
                formatNumber: (v) => (v === null || v === undefined ? "--" : Number(v).toFixed(2)),

            };
        }
    }).mount('#app');
</script>
</body>
</html>